{% extends 'management/base.html' %}
{% load static %}

{% block title %}Tarifs Vidangeur - {{ block.super }}{% endblock %}
{% block page_title %}{{ title }}{% endblock %}

{% block content %}
<div class="card">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <div class="fw-semibold">{{ vidangeur.user.get_full_name }} — {{ vidangeur.user.phone_number }}</div>
        <div class="text-muted small">Type: {% if is_mec %}Mécanique{% else %}Manuelle{% endif %}</div>
      </div>
      <div class="d-flex gap-2">
        <a href="{% url 'management:user_edit' vidangeur.user.id %}" class="btn btn-outline-secondary btn-sm">
          <i class="fas fa-user-edit me-1"></i> Éditer l'utilisateur
        </a>
        <a href="{% url 'management:user_management' %}" class="btn btn-outline-secondary btn-sm">
          <i class="fas fa-users me-1"></i> Utilisateurs
        </a>
      </div>
    </div>

    <form method="post" class="mt-2">
      {% csrf_token %}

      {% if is_mec %}
        <div class="alert alert-info py-2">Définissez un tarif par centre. Laisser vide pour désactiver le tarif d'un centre.</div>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th style="width: 50%">Centre de vidange</th>
                <th style="width: 30%">Tarif (FCFA)</th>
                <th style="width: 20%">Statut</th>
              </tr>
            </thead>
            <tbody>
              {% for row in rows %}
              <tr>
                <td>{{ row.centre.nom }}</td>
                <td>
                  <input type="number" step="0.01" min="0" class="form-control form-control-sm" name="prix_{{ row.centre.id }}"
                         value="{% if row.tarif %}{{ row.tarif.prix }}{% endif %}">
                </td>
                <td>
                  {% if row.tarif and row.tarif.actif %}
                    <span class="badge bg-success">Actif</span>
                  {% elif row.tarif %}
                    <span class="badge bg-secondary">Inactif</span>
                  {% else %}
                    <span class="badge bg-light text-dark">Non défini</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Tarif (FCFA) — Vidangeur manuel</label>
            <input type="number" step="0.01" min="0" class="form-control" name="tarif_manuel" value="{{ tarif_manuel|default:'' }}">
            <div class="form-text">Un seul tarif est appliqué pour tous les centres.</div>
          </div>
        </div>
      {% endif %}

      <div class="mt-4 d-flex justify-content-end gap-2">
        <a href="{% url 'management:user_management' %}" class="btn btn-outline-secondary">Annuler</a>
        <button type="submit" class="btn btn-primary">Enregistrer</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}
